name: ZAP API Scan

on:
  push:
    branches: [main]
  pull_request:
    #paths: ['api-gateway/**']

jobs:
  zap-scan:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Docker login to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ github.token }}

    - name: ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.7.0
      with:
        target: 'https://microservicios-gateway-1qkjvfz9.uc.gateway.dev/api'
        docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
        cmd_options: >
          -t api-gateway/api-spec-v2.yaml
          -f openapi
          -z "-config api.disablekey=true
              -config replacer.full_list(0).description='Auth header'
              -config replacer.full_list(0).enabled=true
              -config replacer.full_list(0).matchtype=REQ_HEADER
              -config replacer.full_list(0).match='.*'
              -config replacer.full_list(0).replacement='Authorization: Bearer ${{ secrets.GATEWAY_BEARER_TOKEN }}'"

    - name: Upload ZAP report
      uses: actions/upload-artifact@v4
      with:
        name: zap-report
        path: report_html.html